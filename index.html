<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Polska Quest — Road to B1 (Expanded, v5)</title>
<style>
:root{
  --bg:#0b1220; --panel:#0f182a; --ink:#e6eefb; --muted:#a3b1c6; --border:#172338;
  --accent:#22c55e; --accent2:#06b6d4; --warn:#eab308; --bad:#ef4444;
  --btn:#132036; --btn2:#182a46; --glow:0 10px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:
 radial-gradient(1400px 800px at 10% -10%, #16263f 0%, #0b1220 60%), var(--bg); color:var(--ink); letter-spacing:.2px}
a{color:#9ad1ff}
.app{max-width:1120px; margin:18px auto 110px; padding:0 16px}
header{display:flex; gap:16px; align-items:center; flex-wrap:wrap}
.h1{font-weight:800; font-size: clamp(20px, 3.3vw, 34px)}
.tag{padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:linear-gradient(to bottom,#0f192b,#0c1627); color:#cbd5e1; font-weight:700}
.controls{margin-left:auto; display:flex; gap:8px; align-items:center}
.btn{background:var(--btn); color:var(--ink); border:1px solid var(--border); padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer}
.btn:hover{background:var(--btn2)}
.btn.small{padding:6px 10px; font-size:13px}
.grid{display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(250px,1fr))}
.card{background:linear-gradient(180deg,#0f182a,#0b1322); border:1px solid var(--border); border-radius:16px; padding:18px; box-shadow:var(--glow); position:relative; overflow:visible}
.progress{height:10px; border-radius:999px; background:#0b1322; border:1px solid var(--border); overflow:hidden}
.progress>div{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2))}
.row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.subtle{color:#a3b1c6; font-weight:700; font-size:12px; letter-spacing:.3px}
.h2{font-weight:800; font-size: clamp(18px, 2.4vw, 24px); margin:4px 0 6px}
.h3{font-weight:800; font-size: clamp(16px, 2.2vw, 20px); margin:0 0 6px}
.kbd{background:#0d1423; padding:2px 6px; border-radius:6px; border:1px solid var(--border); font-weight:700}
.pill{background:#0f1726; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-weight:700; color:#cbd5e1; display:inline-block; margin:2px; word-break:keep-all}
.badge{border:1px solid var(--border); padding:2px 8px; border-radius:8px; font-weight:800}
.primary{color:#12df8f}
.warning{color:#ffdb70}
.danger{color:#ff8b8b}
input[type="text"], textarea{width:100%; background:#0f1726; color:var(--ink); border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:16px}
textarea{min-height:130px; resize:vertical}
.choice{padding:12px; background:#0f1726; border:1px solid var(--border); border-radius:12px; font-weight:700; cursor:pointer; text-align:left; display:block; width:100%}
.choice.correct{outline:2px solid var(--accent)}
.choice.wrong{outline:2px solid var(--bad)}
.list{display:grid; gap:10px}
.center{text-align:center}
footer.fixed{position:fixed; inset:auto 0 0 0; background:rgba(10,16,28,.85); backdrop-filter: blur(8px); border-top:1px solid var(--border)}
footer .inner{max-width:1120px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; color:#cbd5e1}
hr{border:none; height:1px; background:linear-gradient(90deg,#0e1726,#253a63); margin:12px 0}
.hidden{display:none}
.lock{position:absolute; inset:0; background:rgba(7,10,18,.68); border-radius:16px; border:1px dashed #2b3b5d; display:flex; align-items:center; justify-content:center; text-align:center; padding:14px; z-index:2}
.level-banner{margin:18px 0 8px; padding:8px 12px; border:1px solid var(--border); border-radius:12px; background:linear-gradient(180deg, #0f192c, #0c1526); font-weight:800}

/* Ensure options never get cut off on mobile */
.card .list{max-height:70vh; overflow:auto; padding-right:4px}
.sticky-ops{position:sticky; top:0; display:flex; gap:8px; padding:8px 0; background:linear-gradient(180deg, rgba(11,18,32,.98), rgba(11,18,32,.75)); z-index:3; border-bottom:1px solid var(--border)}
.topbar{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px}
</style>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b1220">
<link rel="icon" href="icons/icon-192.png" sizes="192x192">
<link rel="apple-touch-icon" href="icons/icon-192.png">

</head>
<body>
<div class="app" id="app">
  <header>
    <div class="h1">Polska Quest — <span class="subtle">Road to B1 (Expanded, v5)</span></div>
    <span class="tag">A1 → A2 → B1 progression (locked until completed)</span>
    <div class="controls">
      <button class="btn small" id="muteBtn">🔊 Audio on</button>
      <button class="btn small" id="resetBtn">🗑️ Reset</button>
    </div>
    <div style="width:100%">
      <div class="progress"><div id="xpBar"></div></div>
      <div class="row">
        <div class="pill">XP: <b id="xp">0</b></div>
        <div class="pill">Units done: <b id="done">0</b>/18</div>
        <div class="pill">Streak: <b id="streak">0</b> days</div>
        <div class="pill">Level: <b id="lvl">A1</b></div>
      </div>
    </div>
  </header>

  <div id="screen"></div>
</div>

<footer class="fixed">
  <div class="inner tiny">
    <div>Tip: Tap 🔈 for Polish audio. Use <span class="kbd">Enter</span> to submit. You can always <b>Skip</b> a question and use 🏠 Home.</div>
    <div><button class="btn small" id="reviewBtn">📚 Spaced Review</button>
    <button class="btn small" id="examBtn">📝 B1 Mock Exam</button></div>
  </div>
</footer>

<script>
// ===== Voice =====
const voice = { muted:false, voice:null, ready:false };
function loadVoices(){ const vs = speechSynthesis.getVoices(); voice.voice = vs.find(v=>/pl-PL/i.test(v.lang)) || vs.find(v=>v.lang&&v.lang.startsWith('pl')) || vs[0] || null; voice.ready=true; setMuteLabel(); }
if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged = loadVoices; loadVoices(); }
function speak(t){ if(voice.muted || !('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(t); if(voice.voice) u.voice=voice.voice; u.lang=(voice.voice&&voice.voice.lang)||'pl-PL'; u.rate=.95; speechSynthesis.cancel(); speechSynthesis.speak(u); }
function soundBtn(text){ const b=document.createElement('button'); b.className='btn small'; b.textContent='🔈'; b.onclick=e=>{e.stopPropagation(); speak(text);}; return b; }
function setMuteLabel(){ document.getElementById('muteBtn').textContent = voice.muted ? '🔇 Audio off' : '🔊 Audio on'; }
document.getElementById('muteBtn').onclick=()=>{ voice.muted=!voice.muted; setMuteLabel(); };

// ===== Save =====
const SAVE_KEY='PQ_B1_SAVE_V5';
const Save = {
  data: { xp:0, unitsDone:{}, review:[], streak:0, lastDay:null },
  load(){ try{ const x=JSON.parse(localStorage.getItem(SAVE_KEY)||'null'); if(x) this.data=x; }catch(e){} updateHUD(); },
  save(){ localStorage.setItem(SAVE_KEY, JSON.stringify(this.data)); updateHUD(); },
  addXP(n){ this.data.xp += n; if(this.data.xp<0) this.data.xp=0; this.save(); },
  markUnit(id){ this.data.unitsDone[id]=true; this.save(); },
  pushReview(card){ this.data.review.push(card); if(this.data.review.length>500) this.data.review.shift(); this.save(); },
  touchStreak(){ const today = new Date().toISOString().slice(0,10); if(this.data.lastDay!==today){ this.data.streak += 1; this.data.lastDay=today; } this.save(); }
};
function updateHUD(){
  const doneCount = Object.keys(Save.data.unitsDone).length;
  document.getElementById('xp').textContent = Save.data.xp;
  document.getElementById('done').textContent = doneCount + '/18';
  document.getElementById('streak').textContent = Save.data.streak;
  const stage = doneCount>=12 ? 'B1' : doneCount>=6 ? 'A2' : 'A1';
  document.getElementById('lvl').textContent = stage;
  const pct = Math.min(100, Math.round((doneCount/18)*100));
  document.getElementById('xpBar').style.width = pct+'%';
}

// ===== Data =====
const COURSE = [{"id": 1, "level": "A1", "title": "Greetings & Introductions", "topics": ["politeness", "names", "formal/informal"], "vocab": [["cześć", "hi"], ["siema", "hey"], ["hej", "hi"], ["dzień dobry", "good morning/day"], ["dobry wieczór", "good evening"], ["dobranoc", "good night"], ["do widzenia", "goodbye"], ["na razie", "see you"], ["do zobaczenia", "see you later"], ["dziękuję", "thank you"], ["dziękuję bardzo", "thank you very much"], ["proszę", "please / you’re welcome"], ["przepraszam", "sorry / excuse me"], ["nie ma za co", "don’t mention it"], ["miło mi", "nice to meet you"], ["jak masz na imię?", "what’s your name?"], ["mam na imię…", "my name is…"], ["nazywam się…", "my name is…"], ["skąd jesteś?", "where are you from?"], ["jestem z…", "I’m from…"], ["jak się masz?", "how are you?"], ["w porządku", "fine"], ["tak", "yes"], ["nie", "no"], ["rozumiem", "I understand"], ["nie rozumiem", "I don’t understand"], ["proszę powtórzyć", "please repeat"], ["mówię po polsku", "I speak Polish"], ["trochę", "a little"], ["ile masz lat?", "how old are you?"], ["mam … lat", "I am … years old"], ["co u ciebie?", "how’s it going?"], ["wszystko dobrze", "all good"]], "grammar": "<b>Register:</b> Use <i>pan/pani</i> for polite forms; introduce yourself with <i>Nazywam się…</i>.", "dialogues": [{"npc": "Pani Ewa", "q": "Cześć! Jak masz na imię?", "answers": [["Cześć, jestem Adam.", 1], ["Mam dwa lata.", 0], ["Do widzenia!", 0]]}, {"npc": "Pani Ewa", "q": "Dziękuję za pomoc!", "answers": [["Proszę bardzo!", 1], ["Przepraszam.", 0], ["Nie.", 0]]}, {"npc": "Nowa osoba", "q": "Skąd jesteś?", "answers": [["Jestem z Hiszpanii.", 1], ["Mam na imię poniedziałek.", 0], ["Nie rozumiem.", 0]]}]}, {"id": 2, "level": "A1", "title": "Numbers, Colors & Food Shopping", "topics": ["numbers", "colors", "shop"], "vocab": [["zero", "zero"], ["jeden", "one"], ["dwa", "two"], ["trzy", "three"], ["cztery", "four"], ["pięć", "five"], ["sześć", "six"], ["siedem", "seven"], ["osiem", "eight"], ["dziewięć", "nine"], ["dziesięć", "ten"], ["jedenaście", "eleven"], ["dwanaście", "twelve"], ["trzynaście", "thirteen"], ["czternaście", "fourteen"], ["piętnaście", "fifteen"], ["szesnaście", "sixteen"], ["siedemnaście", "seventeen"], ["osiemnaście", "eighteen"], ["dziewiętnaście", "nineteen"], ["dwadzieścia", "twenty"], ["biały", "white"], ["czarny", "black"], ["szary", "gray"], ["brązowy", "brown"], ["czerwony", "red"], ["zielony", "green"], ["niebieski", "blue"], ["żółty", "yellow"], ["pomarańczowy", "orange"], ["fioletowy", "purple"], ["różowy", "pink"], ["chleb", "bread"], ["bułka", "roll"], ["masło", "butter"], ["ser", "cheese"], ["mleko", "milk"], ["jajko", "egg"], ["szynka", "ham"], ["jabłko", "apple"], ["banan", "banana"], ["pomidor", "tomato"], ["ogórek", "cucumber"], ["ziemniaki", "potatoes"], ["kawa", "coffee"], ["herbata", "tea"], ["sok", "juice"], ["woda gazowana", "sparkling water"], ["paragon", "receipt"], ["karta", "card"], ["gotówka", "cash"], ["Ile to kosztuje?", "How much is it?"], ["poproszę…", "I’d like…"], ["czy jest promocja?", "is there a discount?"], ["tani", "cheap"], ["drogi", "expensive"]], "grammar": "<b>Ordering:</b> <i>Poproszę + accusative</i> — Poproszę kawę / wodę / chleb.", "dialogues": [{"npc": "Sprzedawca", "q": "W czym mogę pomóc?", "answers": [["Poproszę chleb i wodę.", 1], ["Mam jabłko.", 0], ["Nie wiem.", 0]]}, {"npc": "Sprzedawca", "q": "To kosztuje pięć złotych.", "answers": [["Dziękuję.", 1], ["Ile masz lat?", 0], ["Czerwony!", 0]]}, {"npc": "Kasjer", "q": "Płaci pan kartą czy gotówką?", "answers": [["Kartą, proszę.", 1], ["Tak, jabłko.", 0], ["Nie ma sprawy.", 0]]}]}, {"id": 3, "level": "A1", "title": "Family & Descriptions", "topics": ["family", "adjectives", "appearance"], "vocab": [["mama", "mother"], ["tata", "father"], ["rodzice", "parents"], ["siostra", "sister"], ["brat", "brother"], ["babcia", "grandmother"], ["dziadek", "grandfather"], ["ciocia", "aunt"], ["wujek", "uncle"], ["kuzyn", "cousin (m.)"], ["kuzynka", "cousin (f.)"], ["mąż", "husband"], ["żona", "wife"], ["syn", "son"], ["córka", "daughter"], ["dziecko", "child"], ["rodzina", "family"], ["wysoki", "tall (m.)"], ["niski", "short (m.)"], ["szczupły", "slim (m.)"], ["gruby", "overweight (m.)"], ["ładna", "pretty (f.)"], ["przystojny", "handsome (m.)"], ["miła", "nice (f.)"], ["miły", "nice (m.)"], ["włosy", "hair"], ["blond", "blond"], ["brunet", "brunette (m.)"], ["szatyn", "brown‑haired (m.)"], ["siwe włosy", "gray hair"], ["oczy", "eyes"], ["niebieskie oczy", "blue eyes"], ["zielone oczy", "green eyes"], ["brązowe oczy", "brown eyes"]], "grammar": "<b>Agreement:</b> Adjectives agree: <i>wysoki chłopak / ładna dziewczyna</i>.", "dialogues": [{"npc": "Znajomy", "q": "Opisz swoją rodzinę, proszę.", "answers": [["Mam brata i siostrę.", 1], ["Mam dworzec.", 0], ["Czerwony kot.", 0]]}, {"npc": "Koleżanka", "q": "Jak wygląda twój brat?", "answers": [["Jest wysoki i ma niebieskie oczy.", 1], ["Jest godzina ósma.", 0], ["Lubię jabłka.", 0]]}]}, {"id": 4, "level": "A1", "title": "Daily Routines & Present Tense", "topics": ["habits", "time of day", "present tense"], "vocab": [["budzę się", "I wake up"], ["wstaję", "I get up"], ["myję się", "I wash"], ["biorę prysznic", "I take a shower"], ["jem śniadanie", "I eat breakfast"], ["idę do pracy", "I go to work"], ["jadę do pracy", "I go to work (by transport)"], ["pracuję", "I work"], ["uczę się", "I study"], ["robię zakupy", "I do the shopping"], ["wracam do domu", "I come back home"], ["gotuję obiad", "I cook lunch/dinner"], ["sprzątam", "I clean"], ["odpoczywam", "I rest"], ["oglądam serial", "I watch a series"], ["czytam książkę", "I read a book"], ["rozmawiam z przyjacielem", "I talk with a friend"], ["spotykam się", "I meet up"], ["ćwiczę", "I exercise"], ["biegnę", "I run"], ["idę spać", "I go to sleep"], ["śpię", "I sleep"], ["w weekend", "on the weekend"], ["zazwyczaj", "usually"], ["czasami", "sometimes"]], "grammar": "<b>Present endings:</b> <i>-m, -sz, -Ø/-e; -my, -cie, -ą</i>; some verbs irregular.", "dialogues": [{"npc": "Kolega", "q": "O której wstajesz?", "answers": [["Wstaję o siódmej.", 1], ["Idę jutro.", 0], ["Czytam książkę.", 0]]}, {"npc": "Koleżanka", "q": "Co robisz po pracy?", "answers": [["Gotuję i odpoczywam.", 1], ["Byłem w pracy.", 0], ["Pojadę jutro.", 0]]}]}, {"id": 5, "level": "A1", "title": "Time, Dates & Appointments", "topics": ["days", "months", "clock", "appointments"], "vocab": [["poniedziałek", "Monday"], ["wtorek", "Tuesday"], ["środa", "Wednesday"], ["czwartek", "Thursday"], ["piątek", "Friday"], ["sobota", "Saturday"], ["niedziela", "Sunday"], ["dziś / dzisiaj", "today"], ["jutro", "tomorrow"], ["pojutrze", "the day after tomorrow"], ["wczoraj", "yesterday"], ["przedwczoraj", "the day before yesterday"], ["godzina", "hour"], ["kwadrans", "quarter"], ["wpół do", "half to"], ["za pięć", "five to"], ["po", "past"], ["termin", "appointment/date"], ["umówić się", "to make an appointment"], ["kalendarz", "calendar"], ["przełożyć", "to reschedule"], ["odwołać", "to cancel"], ["wolny", "free"], ["zajęty", "busy"], ["styczeń", "January"], ["luty", "February"], ["marzec", "March"], ["kwiecień", "April"], ["maj", "May"], ["czerwiec", "June"], ["lipiec", "July"], ["sierpień", "August"], ["wrzesień", "September"], ["październik", "October"], ["listopad", "November"], ["grudzień", "December"]], "grammar": "<b>Questions:</b> <i>Która jest godzina?</i> / <i>Kiedy masz spotkanie?</i>.", "dialogues": [{"npc": "Sekretariat", "q": "Kiedy pasuje spotkanie?", "answers": [["Jutro o dziesiątej.", 1], ["Wczoraj o dziesiątej.", 0], ["Na dworcu.", 0]]}, {"npc": "Recepcja", "q": "Czy możemy przełożyć termin?", "answers": [["Tak, na poniedziałek.", 1], ["Mam dworzec.", 0], ["Czerwony kot.", 0]]}]}, {"id": 6, "level": "A1", "title": "Travel Basics & Directions", "topics": ["tickets", "maps", "places", "navigation"], "vocab": [["lewo", "left"], ["prawo", "right"], ["prosto", "straight"], ["skręć", "turn"], ["skrzyżowanie", "intersection"], ["na rogu", "on the corner"], ["przystanek", "bus stop"], ["rozkład jazdy", "timetable"], ["dworzec", "station"], ["peron", "platform"], ["ulica", "street"], ["plac", "square"], ["mapa", "map"], ["blisko", "near"], ["daleko", "far"], ["lotnisko", "airport"], ["samolot", "airplane"], ["bilet", "ticket"], ["bilet dobowy", "day ticket"], ["kasa biletowa", "ticket office"], ["autobus", "bus"], ["tramwaj", "tram"], ["metro", "metro"], ["autostrada", "highway"], ["zjazd", "exit"], ["na północ", "to the north"], ["na południe", "to the south"], ["na wschód", "to the east"], ["na zachód", "to the west"], ["spóźniony", "delayed"], ["odjazd", "departure"], ["przyjazd", "arrival"]], "grammar": "<b>Prepositions:</b> <i>na + locative</i> (na dworcu), <i>w + locative</i> (w mieście).", "dialogues": [{"npc": "Policjant", "q": "Gdzie jest dworzec?", "answers": [["Prosto i w prawo.", 1], ["Mam bilet.", 0], ["Niebieski dom.", 0]]}, {"npc": "Turysta", "q": "Który peron do Krakowa?", "answers": [["Peron trzeci.", 1], ["Wczoraj rano.", 0], ["Do widzenia!", 0]]}]}, {"id": 7, "level": "A2", "title": "Past Tense — Telling Stories", "topics": ["yesterday", "weekend", "narration"], "vocab": [["wczoraj", "yesterday"], ["tydzień temu", "a week ago"], ["miesiąc temu", "a month ago"], ["w zeszłym roku", "last year"], ["poszedłem/poszłam", "I went (on foot)"], ["pojechałem/pojechałam", "I went (by transport)"], ["wróciłem/wróciłam", "I came back"], ["kupiłem/kupiłam", "I bought"], ["zjadłem/zjadłam", "I ate"], ["wypiłem/wypiłam", "I drank"], ["oglądałem/oglądałam", "I watched"], ["czytałem/czytałam", "I read (past)"], ["spotkałem/spotkałam", "I met"], ["odwiedziłem/odwiedziłam", "I visited"], ["uczyłem się/uczyłam się", "I studied"], ["odpoczywałem/odpoczywałam", "I rested"], ["sprzątałem/sprzątałam", "I cleaned"], ["zrobiłem/zrobiłam zakupy", "I did the shopping"], ["spóźniłem/spóźniłam się", "I was late"], ["zgubiłem/zgubiłam", "I lost"], ["późno", "late"], ["wcześnie", "early"], ["najpierw… potem…", "first… then…"], ["w końcu", "finally"]], "grammar": "<b>Past:</b> gender agreement: <i>kupiłem (m.), kupiłam (f.)</i>.", "dialogues": [{"npc": "Znajomy", "q": "Co robiłeś wczoraj?", "answers": [["Byłem w kinie i kupiłem popcorn.", 1], ["Będę w kinie.", 0], ["Idę do kina.", 0]]}, {"npc": "Kolega", "q": "Kiedy wróciłaś do domu?", "answers": [["Wróciłam późno, o jedenastej.", 1], ["Wracam jutro.", 0], ["Nie wiem.", 0]]}]}, {"id": 8, "level": "A2", "title": "Accusative — Objects in Action", "topics": ["objects", "ordering", "direct objects"], "vocab": [["widzę psa", "I see a dog"], ["mam kota", "I have a cat"], ["piję kawę", "I drink coffee"], ["piję wodę", "I drink water"], ["jem zupę", "I eat soup"], ["jem kanapkę", "I eat a sandwich"], ["czytam książkę", "I read a book"], ["piszę e‑mail", "I write an email"], ["oglądam film", "I watch a movie"], ["zwiedzam miasto", "I tour the city"], ["kupuję bilet", "I buy a ticket"], ["noszę kurtkę", "I wear a jacket"], ["kocham muzykę", "I love music"], ["lubię sport", "I like sport"], ["słyszę muzykę", "I hear music"], ["odwiedzam muzeum", "I visit a museum"], ["gotuję kolację", "I cook dinner"], ["sprzątam mieszkanie", "I clean the apartment"], ["zamawiam pizzę", "I order pizza"], ["bierzesz parasol?", "are you taking an umbrella?"], ["proszę kawę", "coffee, please"], ["poproszę rachunek", "the bill, please"], ["otwieram okno", "I open the window"], ["zamykam drzwi", "I close the door"]], "grammar": "<b>Accusative:</b> masculine animate → <i>-a</i> (pies → psa); after many verbs: widzieć, mieć, lubić, jeść, pić.", "dialogues": [{"npc": "Ktoś", "q": "Co pijesz?", "answers": [["Piję wodę.", 1], ["Piję woda.", 0], ["Mam woda.", 0]]}, {"npc": "Kelner", "q": "Co zamawiasz?", "answers": [["Zamawiam zupę i sałatkę.", 1], ["Idę do muzeum.", 0], ["Byłem w pracy.", 0]]}]}, {"id": 9, "level": "A2", "title": "Genitive — Negation & Quantities", "topics": ["negation", "amounts", "containers"], "vocab": [["nie mam czasu", "I don’t have time"], ["nie mam pieniędzy", "I don’t have money"], ["nie ma problemu", "no problem"], ["dużo pracy", "a lot of work"], ["mało czasu", "little time"], ["trochę cukru", "a bit of sugar"], ["wiele ludzi", "many people"], ["butelka wina", "a bottle of wine"], ["szklanka wody", "a glass of water"], ["kubek herbaty", "a cup of tea"], ["kilogram jabłek", "a kilo of apples"], ["pół kilo sera", "half a kilo of cheese"], ["para butów", "a pair of shoes"], ["paczka ciastek", "a pack of cookies"], ["bez cukru", "without sugar"], ["obok domu", "next to the house"], ["naprzeciw szkoły", "opposite the school"], ["blisko centrum", "near the center"], ["daleko miasta", "far from the city"], ["słucham muzyki", "I listen to music"], ["szukam pracy", "I’m looking for a job"], ["potrzebuję pomocy", "I need help"], ["nie lubię hałasu", "I don’t like noise"], ["nie ma miejsca", "there is no space"]], "grammar": "<b>Genitive:</b> after negation, quantity words, some prepositions (<i>bez, obok, naprzeciw, blisko, daleko</i>).", "dialogues": [{"npc": "Kolega", "q": "Masz czas?", "answers": [["Niestety nie mam czasu.", 1], ["Mam czasu.", 0], ["Mam czasem.", 0]]}, {"npc": "Sprzedawca", "q": "Ile chcesz jabłek?", "answers": [["Kilogram jabłek, proszę.", 1], ["Jabłko jest czerwone.", 0], ["Nie wiem.", 0]]}]}, {"id": 10, "level": "A2", "title": "Dative — Giving & Telling", "topics": ["recipient", "benefit", "pronouns"], "vocab": [["daję mamie prezent", "I give mom a gift"], ["kupuję bratu prezent", "I buy a gift for my brother"], ["pomagam koledze", "I help a friend (m.)"], ["pomagam koleżance", "I help a friend (f.)"], ["dziękuję panu", "I thank you (sir)"], ["dziękuję pani", "I thank you (madam)"], ["radzę koledze", "I advise a friend"], ["opowiadam dzieciom", "I tell children"], ["pokazuję babci zdjęcia", "I show grandma photos"], ["życzę ci powodzenia", "I wish you good luck"], ["wierzę tobie", "I believe you"], ["podaj mi sól", "pass me the salt"], ["smakuje mi zupa", "I like the soup (it tastes good to me)"], ["boli mnie głowa", "my head hurts"], ["przeszkadza mi hałas", "noise bothers me"], ["miło mi panu pomóc", "I’m happy to help you (sir)"], ["należy do ciebie", "it belongs to you"], ["pomagam sąsiadom", "I help neighbors"], ["gratuluję przyjacielowi", "I congratulate a friend"], ["odpowiadam nauczycielce", "I answer the (female) teacher"]], "grammar": "<b>Dative:</b> komu? czemu? Used with <i>pomagać, dziękować, mówić, radzić, wierzyć</i>; also with idioms (<i>smakuje mi</i>).", "dialogues": [{"npc": "Ty", "q": "Komu dziękujesz?", "answers": [["Dziękuję pani Kasi.", 1], ["Dziękuję Kasia.", 0], ["Dziękuję pan.", 0]]}, {"npc": "Mama", "q": "Komu dajesz prezent?", "answers": [["Daję bratu.", 1], ["Daję brat.", 0], ["Daję bratowi dom.", 0]]}]}, {"id": 11, "level": "A2", "title": "Instrumental — With/As & Professions", "topics": ["with", "profession", "interests"], "vocab": [["z przyjacielem", "with a friend (m.)"], ["z przyjaciółką", "with a friend (f.)"], ["z rodziną", "with family"], ["jestem studentem", "I am a student (m.)"], ["jestem studentką", "I am a student (f.)"], ["jestem nauczycielem", "I am a teacher (m.)"], ["jestem lekarką", "I am a doctor (f.)"], ["jestem inżynierem", "I am an engineer (m.)"], ["jestem kierowcą", "I am a driver (m.)"], ["interesuję się sportem", "I’m interested in sports"], ["interesuję się muzyką", "I’m interested in music"], ["interesuję się historią", "I’m interested in history"], ["jestem wegetarianinem", "I’m a vegetarian (m.)"], ["idę z psem", "I’m going with the dog"], ["piszę długopisem", "I write with a pen"], ["nad morzem z rodziną", "at the seaside with family"], ["pracuję z zespołem", "I work with a team"], ["jestem menedżerem", "I am a manager (m.)"], ["jestem sprzedawcą", "I am a salesperson (m.)"], ["jestem artystką", "I am an artist (f.)"], ["jestem programistą", "I am a programmer (m.)"]], "grammar": "<b>Instrumental:</b> after <i>z</i> (with) and professions after <i>być</i>. Endings: <i>-em/-ą</i>.", "dialogues": [{"npc": "Nowy znajomy", "q": "Kim jesteś z zawodu?", "answers": [["Jestem inżynierem.", 1], ["Jestem inżynier.", 0], ["Byłem inżynierem jutro.", 0]]}, {"npc": "Ktoś", "q": "Czym piszesz?", "answers": [["Piszę długopisem.", 1], ["Piszę długopis.", 0], ["Piszę książkę.", 0]]}]}, {"id": 12, "level": "A2", "title": "Locative — Places & Housing", "topics": ["home", "rooms", "city", "after prepositions"], "vocab": [["w domu", "at home"], ["w pracy", "at work"], ["w szkole", "at school"], ["na uniwersytecie", "at the university"], ["w kuchni", "in the kitchen"], ["w łazience", "in the bathroom"], ["w salonie", "in the living room"], ["w sypialni", "in the bedroom"], ["w Warszawie", "in Warsaw"], ["w Krakowie", "in Krakow"], ["na poczcie", "at the post office"], ["na lotnisku", "at the airport"], ["na dworcu", "at the station"], ["w kinie", "in the cinema"], ["w restauracji", "in the restaurant"], ["na uczelni", "at the college"], ["o filmie", "about the film"], ["o pracy", "about work"], ["po obiedzie", "after lunch"], ["po lekcjach", "after classes"], ["na wakacjach", "on holiday"], ["w mieszkaniu", "in the flat"], ["w nowym domu", "in the new house"], ["na ulicy", "on the street"]], "grammar": "<b>Locative:</b> after <i>w, na, o, po</i>; adjectives agree: <i>w nowym domu</i>.", "dialogues": [{"npc": "Recepcja", "q": "Gdzie mieszkasz?", "answers": [["Mieszkam w Warszawie.", 1], ["Mieszkam Warszawa.", 0], ["Na Warszawie.", 0]]}, {"npc": "Znajomy", "q": "O czym rozmawiacie?", "answers": [["O pracy i filmach.", 1], ["Do pracy.", 0], ["Pod pracą.", 0]]}]}, {"id": 13, "level": "B1", "title": "Health & Doctor Visit", "topics": ["symptoms", "advice", "imperative", "pharmacy"], "vocab": [["ból głowy", "headache"], ["gorączka", "fever"], ["ból gardła", "sore throat"], ["kaszel", "cough"], ["katar", "runny nose"], ["osłabienie", "weakness"], ["dreszcze", "shivers"], ["mdłości", "nausea"], ["alergia", "allergy"], ["wysypka", "rash"], ["tabletki", "tablets"], ["syrop", "syrup"], ["antybiotyk", "antibiotic"], ["recepta", "prescription"], ["zwolnienie lekarskie", "sick leave"], ["umówić wizytę", "make an appointment"], ["przyjąć pacjenta", "admit a patient"], ["badanie", "examination"], ["ciśnienie", "blood pressure"], ["temperatura", "temperature"], ["zalecenia", "recommendations"], ["odpoczynek", "rest"], ["dużo pić", "drink a lot"], ["unikać wysiłku", "avoid effort"], ["Proszę głęboko oddychać.", "Please breathe deeply."], ["Czy jest pan/pani uczulony?", "Are you allergic?"], ["Proszę przyjmować lek dwa razy dziennie.", "Please take the medicine twice a day."]], "grammar": "<b>At the doctor:</b> describe symptoms; use polite imperative: <i>Proszę…</i>.", "dialogues": [{"npc": "Lekarz", "q": "Jakie ma pan/pani objawy?", "answers": [["Boli mnie gardło i mam gorączkę.", 1], ["Mam biblioteka.", 0], ["Czerwony autobus.", 0]]}, {"npc": "Farmaceuta", "q": "Czy ma pan/pani receptę?", "answers": [["Tak, tutaj.", 1], ["Jutro rano.", 0], ["Dziękuję bardzo.", 0]]}]}, {"id": 14, "level": "B1", "title": "Work & Job Applications", "topics": ["CV", "interview", "workplace", "formal"], "vocab": [["stanowisko", "position"], ["doświadczenie", "experience"], ["obowiązki", "duties"], ["umiejętności", "skills"], ["kwalifikacje", "qualifications"], ["umowa", "contract"], ["umowa o pracę", "employment contract"], ["umowa zlecenie", "mandate contract"], ["wynagrodzenie", "salary"], ["premia", "bonus"], ["list motywacyjny", "cover letter"], ["życiorys", "resume/CV"], ["ogłoszenie o pracę", "job ad"], ["rekrutacja", "recruitment"], ["rozmowa kwalifikacyjna", "job interview"], ["awans", "promotion"], ["szkolenie", "training"], ["zespół", "team"], ["termin", "deadline"], ["spotkanie", "meeting"], ["zdalnie", "remotely"], ["na pełen etat", "full‑time"], ["Czy możemy umówić się na rozmowę?", "Can we schedule an interview?"], ["W załączeniu przesyłam CV.", "I attach my CV."], ["zakres obowiązków", "scope of duties"], ["dojazd do pracy", "commute to work"], ["grafik", "schedule"], ["praca zmianowa", "shift work"], ["elastyczne godziny", "flexible hours"]], "grammar": "<b>Formal e‑mail:</b> <i>W załączeniu przesyłam CV. Czy możemy umówić się na rozmowę?</i>.", "dialogues": [{"npc": "Rekruter", "q": "Dlaczego chce pan/pani u nas pracować?", "answers": [["Mam doświadczenie i lubię wyzwania.", 1], ["Lubię jabłka.", 0], ["Nie chcę pracy.", 0]]}, {"npc": "Szef", "q": "Czy pasuje jutro o 10:00?", "answers": [["Tak, dziękuję za zaproszenie.", 1], ["Do widzenia.", 0], ["Jutro wczoraj.", 0]]}]}, {"id": 15, "level": "B1", "title": "Housing & Real Estate", "topics": ["renting", "problems", "complaints", "contracts"], "vocab": [["wynajem", "renting"], ["mieszkanie", "apartment"], ["pokój", "room"], ["kaucja", "deposit"], ["czynsz", "rent (payment)"], ["umowa najmu", "rental agreement"], ["współlokator", "flatmate"], ["spółdzielnia", "housing association"], ["administracja", "administration"], ["usterka", "fault"], ["awaria", "breakdown"], ["zgłosić problem", "report a problem"], ["naprawa", "repair"], ["grzejnik", "radiator"], ["ogrzewanie", "heating"], ["ciepła woda", "hot water"], ["winda", "elevator"], ["domofon", "intercom"], ["odczyt liczników", "meter reading"], ["protokół zdawczo‑odbiorczy", "handover protocol"], ["mieszkanie do wynajęcia", "flat for rent"], ["ogłoszenie", "advert"], ["media", "utilities"], ["termin wypowiedzenia", "notice period"], ["odbiór kluczy", "key pickup"], ["zastaw", "deposit/pledge"], ["stan techniczny", "technical condition"], ["spis wyposażenia", "inventory list"]], "grammar": "<b>Complaint:</b> <i>Zgłaszam problem z ogrzewaniem. Proszę o naprawę do piątku.</i>.", "dialogues": [{"npc": "Właściciel", "q": "Czy podpisujemy umowę?", "answers": [["Tak, ale proszę wyjaśnić wysokość kaucji.", 1], ["Nie mam czasu i kot.", 0], ["Chleb jest tani.", 0]]}, {"npc": "Administrator", "q": "Co dokładnie nie działa?", "answers": [["Klimatyzacja nie chłodzi i winda się zacina.", 1], ["Lubię lody.", 0], ["Tak, proszę.", 0]]}]}, {"id": 16, "level": "B1", "title": "Banking & Public Services", "topics": ["bank", "post", "utilities", "formalities"], "vocab": [["bankomat", "ATM"], ["konto", "account"], ["rachunek bankowy", "bank account"], ["przelew", "transfer"], ["zlecenie stałe", "standing order"], ["karta debetowa", "debit card"], ["karta kredytowa", "credit card"], ["prowizja", "fee/commission"], ["saldo", "balance"], ["wpłata", "deposit"], ["wypłata", "withdrawal"], ["wniosek", "application form"], ["formularz", "form"], ["dowód osobisty", "ID card"], ["paszport", "passport"], ["urzędnik", "clerk"], ["urząd", "office"], ["poczta", "post office"], ["list polecony", "registered letter"], ["przesyłka", "parcel"], ["rachunek", "bill/invoice"], ["opłata", "payment/fee"], ["termin płatności", "due date"], ["odsetki", "interest"], ["zaświadczenie", "certificate"], ["załącznik", "attachment"], ["pieczątka", "stamp"], ["kolejka", "queue"], ["okienko", "counter window"], ["numer sprawy", "case number"]], "grammar": "<b>Formalities:</b> <i>Chciałbym otworzyć konto. Jakie dokumenty są potrzebne?</i>.", "dialogues": [{"npc": "Bank", "q": "W czym mogę pomóc?", "answers": [["Chciałbym zrobić przelew zagraniczny.", 1], ["Poproszę kawę.", 0], ["Gdzie dworzec?", 0]]}, {"npc": "Urzędnik", "q": "Brakuje jednego dokumentu.", "answers": [["Czy mogę dosłać zaświadczenie mailem?", 1], ["Tak, jabłko.", 0], ["Nie chcę.", 0]]}]}, {"id": 17, "level": "B1", "title": "Travel & Accommodation (Advanced)", "topics": ["hotel", "complaints", "reservations", "air travel"], "vocab": [["rezerwacja", "reservation"], ["potwierdzenie rezerwacji", "reservation confirmation"], ["zameldowanie", "check‑in"], ["wymeldowanie", "check‑out"], ["pokój dwuosobowy", "double room"], ["pokój jednoosobowy", "single room"], ["klimatyzacja", "air conditioning"], ["śniadanie w cenie", "breakfast included"], ["opłata za noc", "nightly fee"], ["opłata uzdrowiskowa", "city tax"], ["usługa", "service"], ["dodatkowa poduszka", "extra pillow"], ["prośba o cichy pokój", "request for a quiet room"], ["reklamacja", "complaint"], ["odszkodowanie", "compensation"], ["lotnisko", "airport"], ["odprawa", "check‑in (airport)"], ["kontrola bezpieczeństwa", "security check"], ["bramka", "gate"], ["przyloty", "arrivals"], ["odloty", "departures"], ["bagaż rejestrowany", "checked baggage"], ["bagaż podręczny", "hand luggage"], ["opóźniony lot", "delayed flight"], ["odwołany lot", "cancelled flight"], ["przesiadka", "layover/transfer"], ["czy mogliby Państwo…", "could you please…"], ["chciałbym zmienić pokój", "I’d like to change the room"], ["zatwierdzić płatność", "to approve payment"]], "grammar": "<b>Hotel:</b> uprzejme prośby: <i>Czy mogliby Państwo…</i>.", "dialogues": [{"npc": "Recepcja", "q": "Czy wszystko w porządku?", "answers": [["Niestety, klimatyzacja nie działa.", 1], ["Jestem jabłkiem.", 0], ["Jutro wczoraj.", 0]]}, {"npc": "Agent linii", "q": "Lot jest opóźniony o dwie godziny.", "answers": [["Czy mogę dostać voucher na posiłek?", 1], ["Dziękuję, do widzenia.", 0], ["Nie ma problemu.", 0]]}]}, {"id": 18, "level": "B1", "title": "Emergencies, Society & Opinions", "topics": ["112", "documents", "opinions", "linkers"], "vocab": [["wypadek", "accident"], ["awaria", "breakdown"], ["pożar", "fire"], ["pogotowie", "ambulance (service)"], ["policja", "police"], ["zgubić dokumenty", "to lose documents"], ["kradzież", "theft"], ["świadek", "witness"], ["zeznanie", "testimony"], ["ubezpieczenie", "insurance"], ["mandat", "fine"], ["dowód osobisty", "ID card"], ["prawo jazdy", "driver’s license"], ["paszport", "passport"], ["uważam, że", "I think that"], ["moim zdaniem", "in my opinion"], ["ponieważ", "because"], ["dlatego", "therefore"], ["chociaż", "although"], ["jednak", "however"], ["z jednej strony… z drugiej strony…", "on one hand… on the other hand…"], ["jestem za", "I’m in favor"], ["jestem przeciw", "I’m against"], ["przykład", "example"], ["rozwiązanie", "solution"], ["zgłosić na policję", "report to the police"], ["zadzwonić pod 112", "call 112"], ["usunąć usterkę", "remove the fault"]], "grammar": "<b>Emergencies:</b> present facts clearly; Opinions: linkers <i>ponieważ, dlatego, chociaż</i>.", "dialogues": [{"npc": "Policjant", "q": "Co się stało?", "answers": [["Zgubiłem dokumenty, potrzebuję pomocy.", 1], ["Lubię muzykę i...", 0], ["Chcę chleb.", 0]]}, {"npc": "Urzędnik", "q": "Jaki jest pana/pani wniosek?", "answers": [["Chciałbym zgłosić kradzież telefonu.", 1], ["Proszę paragon.", 0], ["Nie wiem.", 0]]}]}];

// ===== Utils =====
function el(tag, cls, html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML=html; return e;}
function screen(node){ const s=document.getElementById('screen'); s.innerHTML=''; s.appendChild(node); window.scrollTo({top:0, behavior:'smooth'}); }
function shuffle(a){ return a.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function sample(a,n){ const c=[...a]; return shuffle(c).slice(0,n); }
function chips(v){ return v.slice(0,10).map(([pl,en])=>`<span class="pill" title="${en}">${pl}</span>`).join(' '); }

// Example sentence generator (simple heuristics)
function makeExample(pl, en){
  if(/\s/.test(pl)) return {pl:`${pl}.`, en:`${en}.`};
  const verbLike = /(ę|sz$|am$|asz$|isz$|uję$)/.test(pl);
  if(verbLike){ return {pl:`Ja ${pl} codziennie.`, en:`I ${en} every day.`}; }
  return {pl:`To jest ${pl}.`, en:`This is ${en}.`};
}

// ===== Home (with level gating) =====
function home(){
  Save.touchStreak();
  const wrap = el('div','');
  wrap.appendChild(el('div','card',`
    <div class="h2">Your pathway</div>
    <div class="subtle">Complete all A1 units to unlock A2. Complete all A2 to unlock B1. XP and review are saved locally.</div>
  `));

  const groups = ['A1','A2','B1'];
  const a1Complete = COURSE.filter(x=>x.level==='A1').every(x=>Save.data.unitsDone[x.id]);
  const a2Complete = COURSE.filter(x=>x.level==='A2').every(x=>Save.data.unitsDone[x.id]);
  groups.forEach(L=>{
    const grid = el('div','grid');
    wrap.appendChild(el('div','level-banner',`Level ${L}`));
    COURSE.filter(u=>u.level===L).forEach(u=>{
      const done = !!Save.data.unitsDone[u.id];
      const card = el('div','card');
      card.innerHTML = `
        <div class="subtle">Unit ${u.id}</div>
        <div class="h3">${u.title}</div>
        <div class="subtle">Topics: ${u.topics.join(', ')}</div>
        <div style="margin:8px 0">${chips(u.vocab)}</div>
        <div class="row">
          <button class="btn" data-id="${u.id}">${done?'✅ Review / Replay':'▶️ Start'}</button>
          <span class="pill">${done?'Completed':'Not started'}</span>
        </div>`;
      let locked=false, reason='';
      if(u.level==='A2' && !a1Complete){ locked=true; reason='Complete all A1 units to unlock A2.'; }
      if(u.level==='B1' && !a2Complete){ locked=true; reason='Complete all A2 units to unlock B1.'; }
      if(locked){
        const overlay = el('div','lock',`🔒 ${reason}`);
        card.appendChild(overlay);
        card.querySelector('button').disabled = true;
      }else{
        card.querySelector('button').onclick=()=>unit(u.id);
      }
      grid.appendChild(card);
    });
    wrap.appendChild(grid);
  });

  const extras = el('div','grid');
  const reviewCard = el('div','card',`<div class="h3">Spaced Review</div><p>Practice your recent mistakes.</p><button class="btn" id="goReview">📚 Review now</button>`);
  reviewCard.querySelector('#goReview').onclick=()=>review();
  const examCard = el('div','card',`<div class="h3">B1 Mock Exam</div><p>Full simulation with instant feedback.</p><button class="btn" id="goExam">📝 Start exam</button>`);
  examCard.querySelector('#goExam').onclick=()=>mockExam();
  extras.appendChild(reviewCard); extras.appendChild(examCard);
  wrap.appendChild(extras);
  screen(wrap);
}
document.getElementById('resetBtn').onclick=()=>{ if(confirm('Reset all progress?')){ localStorage.removeItem(SAVE_KEY); Save.load(); home(); } };
document.getElementById('reviewBtn').onclick=()=>review();
document.getElementById('examBtn').onclick=()=>mockExam();

// ===== Study Materials (Extended) =====
function studyMaterials(u, onStart){
  const wrap = el('div','card');
  const list = el('div','list');
  const top = el('div','topbar');
  const homeBtn = el('button','btn small','🏠 Home');
  homeBtn.onclick=()=>home();
  top.appendChild(el('div', null, `<div class="h2">Study Materials — Unit ${u.id}: ${u.title}</div><div class="subtle">Tap 🔈 to hear words and example sentences.</div>`));
  top.appendChild(homeBtn);
  wrap.appendChild(top);

  // Full vocabulary with audio and example + English
  u.vocab.forEach(([pl,en], idx)=>{
    const ex = makeExample(pl,en);
    const row = el('div','card',
      `<div class="h3"><span class="pill">${pl}</span> <span class="subtle">— ${en}</span></div>
       <div class="row">
         <button class="btn small" id="say_word_${idx}">🔈 Word</button>
         <button class="btn small" id="say_ex_${idx}">🔈 Example</button>
       </div>
       <div class="subtle">PL: ${ex.pl}</div>
       <div class="subtle">EN: ${ex.en}</div>`
    );
    list.appendChild(row);
    setTimeout(()=>{
      row.querySelector(`#say_word_${idx}`).onclick=()=>speak(pl);
      row.querySelector(`#say_ex_${idx}`).onclick=()=>speak(ex.pl);
    });
  });

  const ops = el('div','row');
  const startBtn = el('button','btn','Start unit');
  const skipBtn  = el('button','btn small','Skip study');
  startBtn.onclick=onStart; skipBtn.onclick=onStart;
  ops.appendChild(startBtn); ops.appendChild(skipBtn);

  wrap.appendChild(list);
  wrap.appendChild(ops);
  screen(wrap);
}

// ===== Unit engine =====
function unit(id){
  const u = COURSE.find(x=>x.id===id);
  // First show study materials
  studyMaterials(u, startActivities);
  function startActivities(){
    const wrap = el('div','');
    const top = el('div','topbar');
    const homeBtn = el('button','btn small','🏠 Home');
    homeBtn.onclick=()=>home();
    top.appendChild(el('div', null, `<div class="h2">Unit ${u.id} — ${u.title} <span class="pill">Level ${u.level}</span></div>
       <div class="subtle">Activities: Flashcards → Multiple Choice → Cloze → Dialogue → Listening → Speaking → Writing</div>`));
    top.appendChild(homeBtn);
    wrap.appendChild(top);
    wrap.appendChild(el('div','card',`<div class="progress" style="margin-top:6px"><div id="uBar"></div></div>`));

    const stages = [
      ()=>activityFlashcards(u,next),
      ()=>activityMC(u,next),
      ()=>activityCloze(u,next),
      ()=>activityDialogue(u,next),
      ()=>activityListening(u,next),
      ()=>activitySpeaking(u,next),
      ()=>activityWriting(u,finish)
    ];
    let step=0;
    function next(){ step++; updateBar(); stages[step](); }
    function finish(){ Save.markUnit(u.id); Save.addXP(150); endUnit(u); }
    function updateBar(){ document.getElementById('uBar').style.width = Math.round(step/stages.length*100)+'%'; }
    updateBar(); stages[0]();
    screen(wrap);
  }
}
function endUnit(u){
  const wrap=el('div','card center');
  wrap.innerHTML = `<div class="h2">Unit ${u.id} complete!</div><p>+150 XP</p>
  <div class="row" style="justify-content:center">
    <button class="btn" id="home">🏠 Home</button>
    <button class="btn" id="review">Review mistakes</button>
  </div>`;
  wrap.querySelector('#home').onclick=()=>home();
  wrap.querySelector('#review').onclick=()=>review();
  screen(wrap);
}

// ===== Activities (with Skip buttons) =====
function activityFlashcards(u,done){
  const cont = el('div','card');
  cont.innerHTML = `<div class="h3">Flashcards — Type the meaning</div>`;
  const list = shuffle(u.vocab).slice(0, Math.min(15, u.vocab.length));
  let i=0, good=0;
  const q = el('div','row'); cont.appendChild(q);
  const input = el('input'); input.placeholder='Meaning in English…';
  const btn = el('button','btn small','Check');
  const skip = el('button','btn small','Skip');
  const hint = el('div','subtle');
  function render(){ const [pl,en]=list[i]; q.innerHTML=`<span class="pill">${pl}</span>`; q.appendChild(soundBtn(pl)); input.value=''; hint.textContent=''; }
  function advance(skipped=false){ i++; if(i>=list.length){ cont.appendChild(el('hr')); cont.appendChild(el('div',null,`Score: ${good}/${list.length}`)); const k=el('button','btn','Continue'); k.onclick=done; cont.appendChild(k);} else render(); if(skipped){ Save.pushReview({type:'vocab',pl:list[i-1][0],en:list[i-1][1]}); } }
  btn.onclick=()=>{ const [pl,en]=list[i]; if(input.value.trim().toLowerCase()===en.toLowerCase()){ good++; Save.addXP(5); hint.innerHTML='<span class="primary">✓</span>'; } else { hint.innerHTML=`<span class="danger">✗ ${en}</span>`; Save.pushReview({type:'vocab',pl,en}); } advance(false); };
  skip.onclick=()=>advance(true);
  input.addEventListener('keydown',e=>{ if(e.key==='Enter') btn.click(); });
  cont.appendChild(input); cont.appendChild(btn); cont.appendChild(skip); cont.appendChild(hint);
  cont.appendChild(el('hr')); cont.appendChild(el('div','subtle',u.grammar));
  screen(cont);
}

function activityMC(u,done){
  const cont = el('div','card'); cont.innerHTML='<div class="h3">Multiple choice — pick the meaning</div>';
  const pool = shuffle(u.vocab); let i=0, score=0;
  const list=el('div','list'); cont.appendChild(list);
  const ops=el('div','sticky-ops'); const home=el('button','btn small','🏠 Home'); home.onclick=()=>home(); const skip=el('button','btn small','Skip'); cont.appendChild(ops); ops.appendChild(home); ops.appendChild(skip);
  function render(){ const [pl,en]=pool[i]; list.innerHTML=''; const q=el('div','row',`<span class="pill">${pl}</span>`); q.appendChild(soundBtn(pl)); list.appendChild(q);
    const opts = shuffle([en, ...sample(pool.filter(p=>p[1]!==en).map(x=>x[1]),3)]);
    opts.forEach(o=>{ const b=el('button','choice',o); b.onclick=()=>{ if(o===en){ b.classList.add('correct'); score++; Save.addXP(5);} else { b.classList.add('wrong'); Save.pushReview({type:'vocab',pl,en}); } [...list.querySelectorAll('.choice')].forEach(x=>x.disabled=true); setTimeout(()=>advance(false),360); }; list.appendChild(b); });
  }
  function advance(skipped){ i++; if(i>=Math.min(pool.length,12)){ cont.appendChild(el('hr')); cont.appendChild(el('div',null,`Score: ${score}/${Math.min(pool.length,12)}`)); const k=el('button','btn','Continue'); k.onclick=done; cont.appendChild(k);} else render(); if(skipped){ const [pl,en]=pool[i-1]; Save.pushReview({type:'vocab',pl,en}); } }
  skip.onclick=()=>advance(true);
  render(); screen(cont);
}

function activityCloze(u,done){
  const templates = [
    ['Poproszę __.', 'chleb', 'Poproszę chleb.'],
    ['Mieszkam __ Warszawie.', 'w', 'Mieszkam w Warszawie.'],
    ['Nie mam __.', 'czasu', 'Nie mam czasu.'],
    ['Dziękuję __ pomoc.', 'za', 'Dziękuję za pomoc.'],
    ['Idź __ prawo i potem prosto.', 'w', 'Idź w prawo i potem prosto.'],
    ['Słucham __ wieczorem.', 'muzyki', 'Słucham muzyki wieczorem.'],
    ['Pomagam __ bratu.', 'mojemu', 'Pomagam mojemu bratu.']
  ];
  const deck = shuffle(templates).slice(0,7); let i=0, good=0;
  const cont=el('div','card'); const input=el('input'); input.placeholder='Missing word…'; const hint=el('div','subtle'); const btn=el('button','btn small','Check'); const skip=el('button','btn small','Skip');
  const ops=el('div','row'); const home=el('button','btn small','🏠 Home'); home.onclick=()=>home(); ops.appendChild(home);
  function render(){ const [q,a,full]=deck[i]; cont.innerHTML=`<div class="h3">Cloze — Fill the gap</div><div class="pill">${q}</div>`; cont.appendChild(ops); cont.appendChild(input); cont.appendChild(btn); cont.appendChild(skip); cont.appendChild(hint); input.value=''; hint.textContent=''; }
  function advance(skipped){ i++; if(i>=deck.length){ cont.appendChild(el('hr')); cont.appendChild(el('div',null,`Score: ${good}/${deck.length}`)); const k=el('button','btn','Continue'); k.onclick=done; cont.appendChild(k);} else render(); if(skipped){ const [q,a]=deck[i-1]; Save.pushReview({type:'cloze',q:q,ans:a}); } }
  btn.onclick=()=>{ const [q,a,full]=deck[i]; if(input.value.trim().toLowerCase()===a.toLowerCase()){ good++; Save.addXP(6); hint.innerHTML='<span class="primary">✓</span> '+full; } else { hint.innerHTML='<span class="danger">✗</span> '+full; Save.pushReview({type:'cloze',q,ans:a}); } setTimeout(()=>advance(false),360); };
  skip.onclick=()=>advance(true);
  render(); screen(cont);
}

function activityDialogue(u,done){
  const cont=el('div','card'); cont.appendChild(el('div','h3','Dialogue — choose the reply'));
  let i=0; const ops=el('div','sticky-ops'); const home=el('button','btn small','🏠 Home'); home.onclick=()=>home(); const skip=el('button','btn small','Skip'); ops.appendChild(home); ops.appendChild(skip); cont.appendChild(ops);
  function render(){ const turn=u.dialogues[i]; const body=el('div','list'); cont.insertBefore(body, ops); body.innerHTML=''; const prompt=el('div','row',`<div class="pill"><b>${turn.npc}:</b> ${turn.q}</div>`); body.appendChild(prompt); const choices=el('div','list'); body.appendChild(choices); shuffle(turn.answers).forEach(([txt,ok])=>{ const b=el('button','choice',txt); b.appendChild(soundBtn(txt)); b.onclick=()=>{ if(ok){ b.classList.add('correct'); Save.addXP(8); speak(txt);} else { b.classList.add('wrong'); Save.pushReview({type:'dialogue',q:turn.q,txt}); } [...choices.children].forEach(x=>x.disabled=true); setTimeout(()=>advance(false),460); }; choices.appendChild(b); }); }
  function advance(skipped){ i++; if(i>=u.dialogues.length){ cont.appendChild(el('hr')); const k=el('button','btn','Continue'); k.onclick=done; cont.appendChild(k);} else render(); if(skipped){ Save.pushReview({type:'dialogue-skip',q:u.dialogues[i-1].q}); } }
  skip.onclick=()=>advance(true);
  render(); screen(cont);
}

function activityListening(u,done){
  const cont=el('div','card'); cont.innerHTML='<div class="h3">Listening — play, then answer</div>'; const passage = buildListening(u); const play=el('button','btn small','▶️ Play'); play.onclick=()=>speak(passage.text); cont.appendChild(play); cont.appendChild(el('div','subtle',passage.text));
  passage.qs.forEach(q=>{ cont.appendChild(el('div','pill',q.q)); const options=el('div','list'); shuffle(q.options).forEach(o=>{ const b=el('button','choice',o); b.onclick=()=>{ if(o===q.answer){ b.classList.add('correct'); Save.addXP(7);} else { b.classList.add('wrong'); Save.pushReview({type:'listening',q:q.q,ans:q.answer}); } [...options.children].forEach(x=>x.disabled=true); }; options.appendChild(b); }); cont.appendChild(options); cont.appendChild(el('hr')); });
  const ops=el('div','row'); const home=el('button','btn small','🏠 Home'); home.onclick=()=>home(); const skip=el('button','btn small','Skip section'); const next=el('button','btn','Continue'); skip.onclick=()=>done(); next.onclick=()=>done(); ops.appendChild(home); ops.appendChild(skip); ops.appendChild(next); cont.appendChild(ops);
  screen(cont);
}
function buildListening(u){ const who=['Kasia','Adam','Ewa','Piotr'][Math.floor(Math.random()*4)]; const city=['Warszawie','Krakowie','Gdańsku'][Math.floor(Math.random()*3)]; const topic = u.level==='B1' ? 'spotkanie w urzędzie' : 'zakupy w sklepie'; const text = `${who} ma ${topic} w ${city}. Prosi o pomoc i dziękuje. Potem wraca do domu.`; return { text, qs:[ {q:'W jakim mieście jest wydarzenie?', options:['w Warszawie','w Krakowie','w Gdańsku'], answer:'w '+city}, {q:'Co robi bohater/bohaterka?', options:['ma spotkanie','idzie spać','biega maraton'], answer:'ma spotkanie'} ] }; }

function activitySpeaking(u,done){
  const cont=el('div','card'); cont.innerHTML=`<div class="h3">Speaking — say the line</div><p class="subtle">Click “🎙️ Start” and say the sentence. We’ll detect key words (browser support varies).</p>`; const target = u.dialogues[0]?.answers.find(x=>x[1])[0] || (u.vocab[0]?u.vocab[0][0]:'Dzień dobry.'); const show=el('div','row',`<div class="pill">${target}</div>`); show.appendChild(soundBtn(target)); cont.appendChild(show); const out=el('div','subtle','—'); const start=el('button','btn small','🎙️ Start'); const home=el('button','btn small','🏠 Home'); home.onclick=()=>home(); const skip=el('button','btn small','Skip');
  let recog, ok=false; start.onclick=()=>{ const R=window.SpeechRecognition||window.webkitSpeechRecognition; if(!R){ alert('Speech recognition not supported on this browser.'); return; } recog=new R(); recog.lang='pl-PL'; recog.interimResults=true; recog.onresult=e=>{ const txt=Array.from(e.results).map(r=>r[0].transcript).join(' '); out.textContent=txt; if(!ok && txt.toLowerCase().includes(target.split(' ')[0].toLowerCase())){ ok=true; Save.addXP(10); out.innerHTML+=' <span class="primary">✓</span>'; } }; recog.start(); };
  skip.onclick=()=>done();
  const controls=el('div','row'); controls.appendChild(start); controls.appendChild(skip); controls.appendChild(home); const next=el('button','btn','Continue'); next.onclick=done; controls.appendChild(next); cont.appendChild(controls); cont.appendChild(out);
  cont.appendChild(el('hr')); screen(cont);
}

function activityWriting(u,done){
  const cont=el('div','card'); const prompt = pickPrompt(u); cont.innerHTML = `<div class="h3">Writing — short text</div><p class="subtle">Write ${prompt.min}-${prompt.max} words. Include: <b>${prompt.must.join(', ')}</b>.</p>`; const ta=el('textarea'); const info=el('div','subtle'); const btn=el('button','btn small','Check & finish'); const skip=el('button','btn small','Skip'); const home=el('button','btn small','🏠 Home'); home.onclick=()=>home();
  btn.onclick=()=>{ const text=ta.value.trim(); const words=text.split(/\\s+/).filter(Boolean); const missing=prompt.must.filter(k=>!text.toLowerCase().includes(k.toLowerCase())); let msg='Words: '+words.length+'. '; if(words.length<prompt.min || words.length>prompt.max){ msg+=`<span class="warning">Aim ${prompt.min}-${prompt.max}.</span> `; } else msg+='<span class="primary">Good length.</span> '; if(missing.length){ msg+= 'Missing: <b>'+missing.join(', ')+'</b>'; Save.pushReview({type:'writing',missing,topic:prompt.title}); } else { msg+='<span class="primary">All included.</span>'; Save.addXP(15); done(); } info.innerHTML=msg; };
  skip.onclick=()=>done();
  const ops=el('div','row'); ops.appendChild(btn); ops.appendChild(skip); ops.appendChild(home);
  cont.appendChild(ta); cont.appendChild(ops); cont.appendChild(info); screen(cont);
}
function pickPrompt(u){ const base=[ {title:'E-mail do znajomego o weekendzie (miejsce, osoby, opinia).', must:['w weekend','byłem','byłam','uważam'], min:80, max:140}, {title:'Skarga do hotelu: problem i propozycja rozwiązania.', must:['problem','proszę','naprawić'], min:100, max:160}, {title:'CV — krótki opis doświadczenia i umiejętności.', must:['doświadczenie','umiejętności','pracowałem','pracowałam'], min:100, max:160}, {title:'Wizyta u lekarza — opisz objawy i zalecenia.', must:['boli','gorączka','proszę'], min:90, max:150} ]; return base[Math.floor(Math.random()*base.length)]; }
function newRow(){ const d=el('div','row'); [...arguments].forEach(a=>d.appendChild(a)); return d; }

// ===== Review =====
function review(){ const items=Save.data.review.slice(-30); const wrap=el('div','card'); wrap.innerHTML='<div class="h3">Spaced Review</div>'; if(!items.length){ wrap.appendChild(el('div',null,'No items yet. Complete units first.')); screen(wrap); return; } let i=0,sc=0; function render(){ const it=items[i]; wrap.innerHTML='<div class="h3">Spaced Review</div>'; if(it.type==='vocab'){ const q=el('div','row',`<div class="pill">${it.pl}</div>`); q.appendChild(soundBtn(it.pl)); wrap.appendChild(q); const input=el('input'); input.placeholder='Meaning in English…'; const b=el('button','btn small','Check'); b.onclick=()=>{ if(input.value.trim().toLowerCase()===(it.en||'').toLowerCase()){ sc++; Save.addXP(4);} next(); }; wrap.appendChild(input); wrap.appendChild(b); } else if(it.type==='cloze'){ wrap.appendChild(el('div','pill',it.q)); const input=el('input'); const b=el('button','btn small','Check'); b.onclick=()=>{ if(input.value.trim().toLowerCase()===(it.ans||'').toLowerCase()){ sc++; Save.addXP(4);} next(); }; wrap.appendChild(input); wrap.appendChild(b); } else { const t=it.txt||it.ans||it.en||''; const row=el('div','row',`<div class="pill">${t}</div>`); row.appendChild(soundBtn(t)); wrap.appendChild(row); const k=el('button','btn small','I said it'); k.onclick=()=>{ sc++; Save.addXP(4); next(); }; wrap.appendChild(k);} } function next(){ i++; if(i>=items.length){ wrap.appendChild(el('hr')); wrap.appendChild(el('div',null,`Done: ${sc}/${items.length}`)); const h=el('button','btn','Home'); h.onclick=()=>home(); wrap.appendChild(h);} else render(); } render(); screen(wrap); }

// ===== Mock Exam =====
function mockExam(){ const wrap=el('div',''); const top = el('div','topbar'); const homeBtn=el('button','btn small','🏠 Home'); homeBtn.onclick=()=>home(); top.appendChild(el('div', null, `<div class="h2">Mock Exam</div>`)); top.appendChild(homeBtn); wrap.appendChild(top);
  const parts=['Reading','Listening','Writing','Speaking']; let step=0,score=0; function next(){ step++; if(step>=parts.length){ finish(); } else render(); } function render(){ if(step===0) examReading(()=>{score+=20; next();}, next, wrap); else if(step===1) examListening(()=>{score+=20; next();}, next, wrap); else if(step===2) examWriting(()=>{score+=20; next();}, next, wrap); else if(step===3) examSpeaking(()=>{score+=20; next();}, next, wrap); } function finish(){ const card=el('div','card center'); card.innerHTML=`<div class="h2">Mock Exam Completed</div><p>Sections cleared: <b>${score/20}/4</b>. This is an educational simulation.</p><div class="row center" style="justify-content:center"><button class="btn" id="goHome">🏠 Home</button></div>`; card.querySelector('#goHome').onclick=()=>home(); screen(card);} render(); }
function examReading(pass,fail,wrap){ const card=el('div','card'); const text='Ogłoszenie: W sobotę odbędzie się piknik rodzinny w parku miejskim. Będzie muzyka, gry dla dzieci i stoiska z jedzeniem. Wstęp wolny.'; card.innerHTML=`<div class="h3">Reading</div><p class="subtle">${text}</p>`; const qs=[{q:'Kiedy będzie wydarzenie?',a:'sobotę'},{q:'Gdzie odbędzie się piknik?',a:'w parku'},{q:'Czy wstęp jest płatny?',a:'nie'}]; let correct=0; qs.forEach(o=>{ const inp=el('input'); inp.placeholder=o.q; inp.onchange=()=>{ if(inp.value.toLowerCase().includes(o.a)){ inp.style.outline='2px solid #22c55e'; correct++; } else { inp.style.outline='2px solid #ef4444'; } }; card.appendChild(inp); }); const btn=el('button','btn small','Submit'); const skip=el('button','btn small','Skip section'); btn.onclick=()=>{ if(correct>=2){ Save.addXP(25); pass(); } else fail(); }; skip.onclick=()=>pass(); card.appendChild(btn); card.appendChild(skip); wrap.appendChild(card); }
function examListening(pass,fail,wrap){ const card=el('div','card'); const text='Dzień dobry, pociąg do Poznania odjedzie z peronu trzeciego o godzinie trzynastej trzydzieści.'; card.innerHTML=`<div class="h3">Listening</div><button class="btn small" id="play">▶️ Play</button>`; card.querySelector('#play').onclick=()=>speak(text); const q1=el('input'); q1.placeholder='Z którego peronu odjeżdża pociąg?'; const q2=el('input'); q2.placeholder='O której godzinie?'; card.appendChild(q1); card.appendChild(q2); const btn=el('button','btn small','Submit'); const skip=el('button','btn small','Skip section'); btn.onclick=()=>{ const ok=q1.value.includes('trzec') && (q2.value.includes('13:30')||q2.value.includes('trzynastej')); if(ok){ Save.addXP(25); pass(); } else fail(); }; skip.onclick=()=>pass(); card.appendChild(btn); card.appendChild(skip); wrap.appendChild(card); }
function examWriting(pass,fail,wrap){ const card=el('div','card'); card.innerHTML='<div class="h3">Writing</div><p class="subtle">Napisz 100–160 słów: e-mail do biura podróży z prośbą o informacje o wycieczce. Zadaj 3 pytania i przedstaw siebie.</p>'; const ta=el('textarea'); const ops=el('div','row'); const skip=el('button','btn small','Skip section'); const btn=el('button','btn small','Submit'); btn.onclick=()=>{ const wc=ta.value.trim().split(/\\s+/).filter(Boolean).length; if(wc>=100 && /\\?/.test(ta.value) && /nazywam|mam na imię|jestem/i.test(ta.value)){ Save.addXP(25); pass(); } else fail(); }; skip.onclick=()=>pass(); card.appendChild(ta); ops.appendChild(btn); ops.appendChild(skip); card.appendChild(ops); wrap.appendChild(card); }
function examSpeaking(pass,fail,wrap){ const card=el('div','card'); card.innerHTML='<div class="h3">Speaking</div><p class="subtle">Opowiedz o swoich planach na weekend (użyj przyszłości).</p>'; const start=el('button','btn small','🎙️ Start'); const skip=el('button','btn small','Skip section'); const out=el('div','subtle','—'); let recog, hit=false; start.onclick=()=>{ const R=window.SpeechRecognition||window.webkitSpeechRecognition; if(!R){ alert('Speech recognition unsupported.'); return; } recog=new R(); recog.lang='pl-PL'; recog.interimResults=true; recog.onresult=e=>{ const txt=Array.from(e.results).map(r=>r[0].transcript).join(' '); out.textContent=txt; if(/będę|pójdę|zrobię|przeczytam|obejrzę/i.test(txt)) hit=true; }; recog.onend=()=>{ if(hit){ Save.addXP(25); pass(); } else fail(); }; recog.start(); }; skip.onclick=()=>pass(); card.appendChild(newRow(start, skip)); card.appendChild(out); wrap.appendChild(card); }

// ===== Init =====
Save.load(); home();
</script>

<script>
// Register service worker for offline use
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./sw.js').catch(function(err){ console.warn('SW registration failed', err); });
  });
}
</script>

</body>
</html>
